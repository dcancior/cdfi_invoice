<odoo>
    <!-- Inherit invoice report (from module accounting) -->
    <template id="report_invoice_inherit_cdfi" inherit_id="account.report_invoice_document">
    
        <!-- Agregar CSS al inicio del template -->
        <xpath expr="." position="inside">
            <style>
                /* Espaciado adicional en páginas siguientes para evitar conflicto con header */
                @media print {
                    .page:not(:first-child) {
                        margin-top: 120px !important;
                        padding-top: 40px !important;
                    }
                    
                    /* Asegurar que el QR no se superponga */
                    div[name="cadenas"] {
                        margin-top: 20px !important;
                        page-break-inside: avoid !important;
                    }
                    
                    /* Espaciado adicional para elementos CFDI */
                    .cfdi-section {
                        margin-top: 15px !important;
                        margin-bottom: 15px !important;
                    }
                }
                
                /* También aplicar en vista previa */
                .page:not(:first-child) {
                    margin-top: 100px;
                    padding-top: 30px;
                }
            </style>
        </xpath>

        <!--REPLACE THE INFORMATION DIV WITH THE NEW INFO-->
        <xpath expr="//div[@id='informations']" position="replace">
            <div id="informations" class="row mt-2 mb-2" style="margin-bottom: 8px; font-size: 11px;">
                <div class="col-auto mw-100 mb-1" t-if="o.invoice_date" name="invoice_date" style="line-height: 1.1;">
                    <strong>Fecha de factura:</strong>
                    <p class="m-0" t-field="o.invoice_date"/>
                </div>
                <div class="col-auto mw-100 mb-1" t-if="o.invoice_date_due" name="due_date" style="line-height: 1.1;">
                    <strong>Fecha de vencimiento:</strong>
                    <p class="m-0" t-field="o.invoice_date_due"/>
                </div>
                <div class="col-auto mw-100 mb-1" t-if="o.uso_cfdi_id" name="origin" style="line-height: 1.1;">
                    <strong>Uso:</strong>
                    <p class="m-0" t-field="o.uso_cfdi_id.code"/>
                </div>
                <div class="col-auto mw-100 mb-1" t-if="o.methodo_pago" name="reference" style="line-height: 1.1;">
                    <strong>Método de pago:</strong>
                    <p class="m-0" t-field="o.methodo_pago"/>
                </div>
                <div class="col-auto mw-100 mb-1" t-if="o.forma_pago_id" name="customer_code" style="line-height: 1.1;">
                    <strong>Forma de pago:</strong>
                    <p class="m-0" t-field="o.forma_pago_id.code"/>
                </div>
                
            </div>
        </xpath>

        <!--PUT THE ADDRESS AFTER THE INFORMATION OF THE INVOICE-->
        <xpath expr="//div[@id='informations']" position="after">
            <t t-if="o.company_id.modo_prueba == True">
                <div style="position:absolute;opacity:0.25;z-index:1000;width:100%;">
                    <center><span style="font-size:60px;color:red;">FACTURA DE PRUEBA</span></center>
                </div>
            </t>

            <t t-if="o.estado_factura == 'factura_cancelada'">
                <div style="position:absolute;opacity:0.25;z-index:1000;width:100%;">
                    <center><span style="font-size:60px;color:red;">CANCELADO</span></center>
                </div>
            </t>

            <div id="comprobante_emision" class="row" style="margin-bottom: 5px; font-size: 11px;">
                <div class="col-auto mw-100 mb-1" t-if="o.tipo_comprobante" name="tipo_comprobante" style="line-height: 1.1;">
                    <strong>Tipo comprobante:</strong>
                    <p class="m-0" t-field="o.tipo_comprobante"/>
                </div>
                <div class="col-auto mw-100 mb-1" t-if="o.fecha_factura" name="fecha_factura" style="line-height: 1.1;">
                    <strong>Fecha de emisión:</strong>
                    <p class="m-0" t-field="o.fecha_factura"/>
                </div>
            </div>
            
            <div name="general_information" class="row" style="margin-bottom: 4px;">
                <div class="col-6" style="font-size:10px; line-height: 1.1;">
                    <span t-if="o.move_type == 'out_invoice'"><strong>Datos receptor:</strong></span>
                    <span t-if="o.move_type == 'in_invoice'"><strong>Datos emisor:</strong></span><br/>
                    <span t-field="o.partner_id.name"/><br/>
                    <span t-field="o.partner_id.street"/> <span t-field="o.partner_id.street2"/><br/>
                    <span t-field="o.partner_id.state_id.name"/>, <span t-field="o.partner_id.city"/><br/>
                    <span t-field="o.partner_id.vat"/><br/>
                    Regimen fiscal: <span t-field="o.partner_id.regimen_fiscal_id.code"/> C.P <span t-field="o.partner_id.zip"/> <br/>
                </div>
                <div class="col-6" style="font-size:10px; line-height: 1.1;">
                    <t t-if="o.move_type == 'out_invoice'">
                        <strong>Datos emisor:</strong><br/>
                        Nombre emisor: <span t-field="o.company_id.nombre_fiscal"/><br/>
                        Rfc Emisor: <span t-field="o.company_id.vat"/><br/>
                        Regimen fiscal: <span t-field="o.company_id.regimen_fiscal_id.code"/><br/>
                        Lugar de expedición:
                        <t t-if="o.journal_id.codigo_postal">
                            <span t-field="o.journal_id.codigo_postal"/>
                        </t>
                        <t t-if="not o.journal_id.codigo_postal">
                            <span t-field="o.company_id.partner_id.zip"/>
                        </t>
                    </t>
                </div>
            </div>
        </xpath>

        <xpath expr="//table[@name='invoice_line_table']" position="replace">
            <table class="table table-sm o_main_table table-borderless" style="font-size: 9px; margin-bottom: 5px;">
                <thead>
                    <tr style="line-height: 1.0;">
                        <th style="padding: 2px 3px; font-size: 8px;">Clave Producto</th>
                        <th class="text-right" style="padding: 2px 3px; font-size: 8px;">Cantidad</th>
                        <th class="text-right" style="padding: 2px 3px; font-size: 8px;">Unidad</th>
                        <th width="40%" style="padding: 2px 3px; font-size: 8px;">Descripción</th>
                        <th class="text-right" style="padding: 2px 3px; font-size: 8px;">Precio Unitario</th>
                        <th t-if="display_discount" class="text-right" style="padding: 2px 3px; font-size: 8px;">Descuento</th>
                        <th class="text-right" style="padding: 2px 3px; font-size: 8px;">Impuesto</th>
                        <th class="text-right" style="padding: 2px 3px; font-size: 8px;">
                            <span groups="account.group_show_line_subtotals_tax_excluded">Importe</span>
                            <span groups="account.group_show_line_subtotals_tax_included">Total</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="invoice_tbody">
                    <tr t-foreach="o.invoice_line_ids" t-as="l" style="page-break-inside: avoid; line-height: 1.0;">
                        <t t-if="l.quantity > 0 and l.display_type != 'line_section' and l.display_type != 'line_note'">
                            <t t-set="price" t-value="l.price_unit * (1 - (l.discount or 0.0) / 100.0)"/>
                            <t t-set="amounts" t-value="l.tax_ids.compute_all(price, l.currency_id, l.quantity, product=l.product_id, partner=l.move_id.partner_id)"/>
                            <t t-set="price_exclude_tax" t-value="amounts['total_excluded']"/>
                            <t t-set="price_include_tax" t-value="amounts['total_included']"/>
                            <t t-set="price_exclude_tax" t-value="l.move_id.currency_id.round(price_exclude_tax)"/>
                            <t t-set="price_include_tax" t-value="l.move_id.currency_id.round(price_include_tax)"/>
                            <t t-set="taxes" t-value="amounts['taxes']"/>
                            
                            <td style="padding: 1px 2px; font-size: 9px;">
                                <span t-field="l.product_id.clave_producto" />
                            </td>
                            <td class="text-right" style="padding: 1px 2px; font-size: 9px;">
                                <span t-field="l.quantity" />
                            </td>
                            <td style="padding: 1px 2px; font-size: 8px;">
                                <span t-field="l.product_id.cat_unidad_medida.clave" /> - <span t-field="l.product_id.cat_unidad_medida.descripcion" />
                            </td>
                            <td style="padding: 1px 2px; font-size: 9px; max-width: 200px; word-wrap: break-word;">
                                <span t-field="l.name" t-options="{'widget': 'text'}"/>
                            </td>
                            <td class="text-right" style="padding: 1px 2px; font-size: 9px;">
                                <span t-field="l.price_unit" t-options='{"widget": "monetary", "display_currency": l.move_id.currency_id}'/>
                            </td>
                            <td t-if="display_discount" class="text-right" style="padding: 1px 2px; font-size: 9px;">
                                <span t-esc="l.price_unit * ((l.discount or 0.0) / 100.0) *l.quantity" t-options='{"widget": "monetary", "display_currency": l.move_id.currency_id}'/>
                            </td>
                            <td class="bordesless" style="padding: 1px 2px;">
                                <table width="100%">
                                    <tr t-foreach="l.tax_ids" t-as="tax">
                                        <t t-foreach="taxes" t-as="m">
                                            <t t-if="m['id'] == tax.id">
                                                <td class="text-right" width="25%" style="font-size:8px; padding: 0;">
                                                    <span t-field="tax.name" />
                                                </td>
                                            </t>
                                        </t>
                                    </tr>
                                </table>
                            </td>
                            <td class="text-right" style="padding: 1px 2px; font-size: 9px;">
                                <span t-field="l.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                                <span t-field="l.price_total" groups="account.group_show_line_subtotals_tax_included"/>
                            </td>
                        </t>
                        
                        <t t-if="l.display_type == 'line_section'" class="bg-200 font-weight-bold o_line_section">
                            <td colspan="99" style="padding: 1px 2px; font-size: 9px;">
                                <span t-field="l.name" t-options="{'widget': 'text'}"/>
                            </td>
                            <t t-set="current_section" t-value="line"/>
                            <t t-set="current_subtotal" t-value="0"/>
                        </t>
                        <t t-if="l.display_type == 'line_note'">
                            <td colspan="99" style="padding: 1px 2px; font-size: 9px;">
                                <span t-field="l.name" t-options="{'widget': 'text'}"/>
                            </td>
                        </t>
                    </tr>
                </tbody>
            </table>
        </xpath>

        <!-- Eliminar la comunicación de pago duplicada del template base -->
        <xpath expr="//p[@name='payment_communication']" position="replace">
        </xpath>

        <xpath expr="//div[@class='clearfix mb-4']" position="replace">
            <div class="clearfix mb-4">
                <div id="total" class="row">
                    <!-- Columna izquierda para el total en letra -->
                    <div class="col-6">
                        <div style="color: black; font-size: 11px; padding-top: 10px;">
                            <strong><span t-esc="o._get_amount_2_text(o.amount_total)" /></strong>
                        </div>
                        
                        <!-- Información de comunicación de pago debajo del total en letra -->
                        <p t-if="o.move_type in ('out_invoice', 'in_refund') and o.payment_reference" name="payment_communication" style="margin-top: 15px; font-size: 10px;">
                            <strong>Utilice la siguiente comunicación para su pago:</strong> <b><span t-field="o.payment_reference"/></b>
                            <t t-if="o.partner_bank_id">
                                <br/>
                                <strong>En esta cuenta:</strong> <span t-field="o.partner_bank_id" class="fw-bold"/>
                            </t>
                        </p>
                    </div>
                    
                    <!-- Columna derecha para los totales numéricos -->
                    <div t-attf-class="#{'col-6' if report_type != 'html' else 'col-sm-6 col-md-6'}">
                        <table class="table table-sm table-borderless" style="page-break-inside: avoid;">
                            <!--Tax totals-->
                            <t t-set="tax_totals" t-value="o.tax_totals"/>
                            <t t-call="account.document_tax_totals"/>

                            <!--Payments-->
                            <t t-if="print_with_payments">
                                <t t-if="o.payment_state != 'invoicing_legacy'">
                                    <t t-set="payments_vals" t-value="o.sudo().invoice_payments_widget and o.sudo().invoice_payments_widget['content'] or []"/>
                                    <t t-foreach="payments_vals" t-as="payment_vals">
                                        <tr t-if="payment_vals['is_exchange'] == 0">
                                            <td>
                                                <i class="oe_form_field text-end oe_payment_label">Pagado el <t t-esc="payment_vals['date']" t-options='{"widget": "date"}'/></i>
                                            </td>
                                            <td class="text-end">
                                                <span t-esc="payment_vals['amount']" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                            </td>
                                        </tr>
                                    </t>
                                    <t t-if="len(payments_vals) > 0">
                                        <tr class="border-black fw-bold">
                                            <td>Cantidad adeudada</td>
                                            <td class="text-end">
                                                <span t-field="o.amount_residual"/>
                                            </td>
                                        </tr>
                                    </t>
                                </t>
                            </t>
                        </table>
                    </div>
                </div>
            </div>
        </xpath>

        <xpath expr="//div[@name='comment']" position="before">
            <t t-if="o.tipo_relacion">
                <div class="row cfdi-section" style="font-size: 10px; margin-bottom: 5px;">
                    <div>
                        <strong>CFDI Relacionado </strong>
                    </div>
                    <div>
                        Tipo de Relación: <span t-field="o.tipo_relacion" />
                    </div>
                    <div>
                        CFDI Relacionado: <span t-field="o.uuid_relacionado" />
                    </div>
                </div>
            </t>

            <div t-if="o.folio_fiscal" class="col-12 cfdi-section" style="font-size:8px; margin-top: 15px;">
                <table class="borderless" cellspacing="0" style="width:100%;border:none;border-collapse:separate;border-spacing: 1px; line-height: 1.0;">
                    <tr>
                        <td style="padding: 1px 2px;">
                            <strong>Método de pago</strong>
                        </td>
                        <td style="padding: 1px 2px;">
                            <span t-field="o.methodo_pago" />
                        </td>
                        <td style="padding: 1px 2px;">
                            <strong>Fecha y hora de certificación</strong>
                        </td>
                        <td style="padding: 1px 2px;">
                            <span t-field="o.fecha_certificacion" />
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 1px 2px;">
                            <strong>Moneda</strong>
                        </td>
                        <td style="padding: 1px 2px;">
                            <span t-field="o.moneda" />
                        </td>
                        <td style="padding: 1px 2px;">
                            <strong>Certificado SAT</strong>
                        </td>
                        <td style="padding: 1px 2px;">
                            <span t-field="o.cetificaso_sat" />
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 1px 2px;">
                            <strong>Tipo de cambio</strong>
                        </td>
                        <td style="padding: 1px 2px;">
                            <span t-field="o.tipocambio" />
                        </td>
                        <td style="padding: 1px 2px;">
                            <strong>Folio fiscal</strong>
                        </td>
                        <td style="padding: 1px 2px;">
                            <span t-field="o.folio_fiscal" />
                        </td>
                    </tr>
                    <tr>
                        <td style="padding: 1px 2px;">
                            <strong>Número de certificado</strong>
                        </td>
                        <td style="padding: 1px 2px;">
                            <span t-field="o.numero_cetificado" />
                        </td>
                    </tr>
                </table>
            </div>
        </xpath>

        <xpath expr="//div[@name='comment']" position="after">
            <div t-if="o.folio_fiscal" name="cadenas" class="row" style="page-break-inside: avoid; margin-top: 25px; clear: both;">
                <div class="barcode col-3">
                    <img t-if="o.qrcode_image" t-att-src="image_data_uri(o.qrcode_image)" style="height: 120px;width: 120px;" />
                </div>
                <div class="col-9" style="font-size:7px; line-height: 1.0;">
                    <strong>Cadena Original del Complemento digital del SAT</strong><br/>
                    <span t-field="o.cadena_origenal" style="font-size:6px; line-height: 1.0;"/><br/>

                    <strong>Sello digital del CFDI</strong><br/>
                    <span t-field="o.selo_digital_cdfi" style="font-size:6px; line-height: 1.0;"/><br/>

                    <strong>Sello del SAT</strong><br/>
                    <span t-field="o.selo_sat" style="font-size:6px; line-height: 1.0;"/><br/>
                </div>
            </div>

            <p t-if="o.folio_fiscal" style="margin-top: 15px; clear: both;">
                <center>
                    <strong style="font-size: 10px;">ESTE DOCUMENTO ES UNA REPRESENTACIÓN IMPRESA DE UN CFDI</strong>
                </center>
            </p>
        </xpath>

        <!-- AGREGAR DATOS DEL VEHÍCULO AL FINAL -->
        <xpath expr="//div[@name='comment']" position="before">
            <!-- Solo mostrar si la factura tiene una orden de venta asociada -->
            <t t-if="o.invoice_origin">
                <t t-set="sale_order" t-value="o.env['sale.order'].search([('name', '=', o.invoice_origin)], limit=1)"/>
                <t t-if="sale_order">
                    <div style="border:2px solid #888; border-radius:8px; padding:12px; margin-top:24px; clear:both;">
                        <h4 style="margin-bottom:8px; color:#444;">Datos del Vehículo</h4>
                        <p style="font-size:10px; line-height:1.4; margin:0;">
                            <strong>Marca:</strong> <t t-esc="dict(sale_order._fields['marca_auto'].selection).get(sale_order.marca_auto, '') if sale_order else ''"/>, 
                            <strong>Modelo:</strong> <t t-esc="sale_order.nombre_auto.name if sale_order.nombre_auto else ''"/>, 
                            <strong>Año:</strong> <t t-esc="sale_order.anio_auto or ''"/>, 
                            <strong>Color:</strong> <t t-esc="sale_order.color_auto or ''"/>, 
                            <strong>VIN:</strong> <t t-esc="sale_order.serie_auto or ''"/>, 
                            <strong>Placas:</strong> <t t-esc="sale_order.placas_auto or ''"/>, 
                            <strong>Kilometraje:</strong> <t t-esc="sale_order.kilometraje_auto or ''"/>, 
                            <strong>Tipo de combustible:</strong> <t t-esc="sale_order.tipo_combustible or ''"/>, 
                            <strong>Nivel de Combustible:</strong> <t t-esc="sale_order.tanque_gasolina or ''"/>, 
                            <strong>Operador:</strong> <t t-esc="sale_order.nombre_operador or ''"/>, 
                            <strong>Número de Unidad:</strong> <t t-esc="sale_order.num_unidad or ''"/>
                            <t t-if="sale_order.observations">
                                <br/><strong>Observaciones:</strong> <t t-esc="sale_order.observations"/>
                            </t>
                        </p>
                    </div>
                </t>
            </t>
        </xpath>

    </template>
</odoo>