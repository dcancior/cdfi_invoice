<odoo>
    <!-- ========================= -->
    <!--  INHERIT FACTURA (QWEB)   -->
    <!-- ========================= -->
    <template id="report_invoice_inherit_cdfi" inherit_id="account.report_invoice_document">
    
        <!-- Estilos para margen y secciones CFDI -->
        <xpath expr="." position="inside">
            <style>
                /* Espaciado adicional en páginas siguientes para evitar conflicto con header */
                @media print {
                    .page:not(:first-child) {
                        margin-top: 120px !important;
                        padding-top: 40px !important;
                    }
                    
                    /* Asegurar que el QR no se superponga */
                    div[name="cadenas"] {
                        margin-top: 20px !important;
                        page-break-inside: avoid !important;
                    }
                    
                    /* Espaciado adicional para elementos CFDI */
                    .cfdi-section {
                        margin-top: 15px !important;
                        margin-bottom: 15px !important;
                    }
                }
                
                /* También aplicar en vista previa */
                .page:not(:first-child) {
                    margin-top: 100px;
                    padding-top: 30px;
                }

                /* Tamaños de texto específicos */
                .hdr-meta-12 { font-size: 12px !important; color: #000 !important; }
                .hdr-date-12 { font-size: 12px !important; color: #000 !important; }

                /* Unificación de encabezados y contenido */
                .hdr-block-uni strong { font-size: 12px !important; font-weight: 700 !important; color: #000 !important; }
                .hdr-block-uni .val,
                .hdr-block-uni p,
                .hdr-block-uni span:not(strong) { font-size: 11px !important; font-weight: 400 !important; }

                /* Tabla de líneas: encabezado 12 (negritas), cuerpo 11 */
                .invoice-body-11 thead th { font-size: 12px !important; font-weight: 700 !important; }
                .invoice-body-11 tbody td { font-size: 11px !important; font-weight: 400 !important; }

                /* Bloque de vehículo con mismo ancho visual que la tabla de productos */
                .veh-block { margin-top:16px; }
                .veh-title { font-size:14px !important; font-weight:700 !important; color:#000; margin:0 0 6px 0; }
                .veh-table { width:100%; max-width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
                .veh-table td { border:1px solid #ddd; padding:6px 8px; vertical-align:top; word-wrap:break-word; }
                .veh-label { font-weight:700 !important; font-size:12px !important; background:#f9f9fb; white-space:nowrap; color:#000; }
                .veh-val { font-weight:400 !important; font-size:11px !important; }
            </style>
        </xpath>

        <!-- 1) Eliminar el bloque de dirección bajo el encabezado -->
        <xpath expr="//div[@class='row'][.//div[@name='address_not_same_as_shipping'] or .//div[@name='address_same_as_shipping'] or .//div[@name='no_shipping']]" position="replace">
        </xpath>

        <!-- 2) Quitar el margen superior para que el título sea la primera línea -->
        <xpath expr="//div[@class='mt-5'][1]" position="attributes">
            <attribute name="class">mt-0</attribute>
        </xpath>

        <!-- Título dinámico (Nota de Venta si desglosar_iva = 'no') + fecha pegada a la derecha -->
        <xpath expr="//h2" position="replace">
            <h2 style="position:relative; width:100%;">
                <t t-set="is_nota_venta"
                   t-value="o.move_type == 'out_invoice' and ((getattr(o, 'desglosar_iva', getattr(o,'desglose_iva','')) or '') in ('no','No','NO'))"/>

                <span>
                    <t t-if="is_nota_venta">
                        <span t-if="o.state == 'posted'">Nota de Venta</span>
                        <span t-if="o.state == 'draft'">Borrador de Nota de Venta</span>
                        <span t-if="o.state == 'cancel'">Nota de Venta Cancelada</span>
                    </t>
                    <t t-else="">
                        <span t-if="o.move_type == 'out_invoice' and o.state == 'posted'">Factura</span>
                        <span t-if="o.move_type == 'out_invoice' and o.state == 'draft'">Borrador de Factura</span>
                        <span t-if="o.move_type == 'out_invoice' and o.state == 'cancel'">Factura Cancelada</span>
                        <span t-if="o.move_type == 'out_refund'">Nota de Crédito</span>
                        <span t-if="o.move_type == 'in_invoice'">Factura del Proveedor</span>
                        <span t-if="o.move_type == 'in_refund'">Nota de crédito del proveedor</span>
                    </t>
                    <span class="hdr-meta-12">
                        <span t-if="o.name != '/'" t-esc="' — '"/>
                        <span t-if="o.name != '/'" t-field="o.name"/>
                    </span>
                </span>

                <!-- Fecha a la derecha (tamaño 12 en encabezado; tú pediste mantener estilos del título intactos) -->
                <span t-if="is_nota_venta and o.invoice_date" class="hdr-date-12" style="position:absolute; right:0; top:0;">
                    <span t-field="o.invoice_date"/>
                </span>
            </h2>
        </xpath>

        <!-- Información principal -->
        <xpath expr="//div[@id='informations']" position="replace">
            <div id="informations" class="row mt-2 mb-2 hdr-block-uni" style="margin-bottom: 8px;">
                <!-- Bandera reutilizable -->
                <t t-set="nv_raw" t-value="getattr(o, 'desglosar_iva', getattr(o,'desglose_iva',''))"/>
                <t t-set="nv_is_no" t-value="(nv_raw in ('no','No','NO')) or (nv_raw in (False, 0, None))"/>

                <!-- Fechas solo si NO es Nota de Venta -->
                <div class="col-auto mw-100 mb-1" t-if="o.invoice_date and (not nv_is_no)" name="invoice_date" style="line-height: 1.1;">
                    <strong>Fecha de factura:</strong>
                    <p class="m-0 val" t-field="o.invoice_date"/>
                </div>
                <div class="col-auto mw-100 mb-1" t-if="o.invoice_date_due and (not nv_is_no)" name="due_date" style="line-height: 1.1;">
                    <strong>Fecha de vencimiento:</strong>
                    <p class="m-0 val" t-field="o.invoice_date_due"/>
                </div>

                <!-- Ocultar 'Uso' si nv_is_no -->
                <div class="col-auto mw-100 mb-1" t-if="o.uso_cfdi_id and (not nv_is_no)" name="origin" style="line-height: 1.1;">
                    <strong>Uso:</strong>
                    <p class="m-0 val">
                        <t t-esc="o.uso_cfdi_id.description or o.uso_cfdi_id.name or o.uso_cfdi_id.display_name"/>
                        <t t-if="o.uso_cfdi_id.code"> (<t t-esc="o.uso_cfdi_id.code"/>)</t>
                    </p>
                </div>

                <div class="col-auto mw-100 mb-1" t-if="o.methodo_pago" name="reference" style="line-height: 1.1;">
                    <strong>Método de pago:</strong>
                    <p class="m-0 val">
                        <span t-field="o.methodo_pago"/> (<t t-esc="o.methodo_pago"/>)
                    </p>
                </div>
                <div class="col-auto mw-100 mb-1" t-if="o.forma_pago_id" name="customer_code" style="line-height: 1.1;">
                    <strong>Forma de pago:</strong>
                    <p class="m-0 val">
                        <t t-esc="o.forma_pago_id.description or o.forma_pago_id.name or o.forma_pago_id.display_name"/>
                        <t t-if="o.forma_pago_id.code"> (<t t-esc="o.forma_pago_id.code"/>)</t>
                    </p>
                </div>
            </div>
        </xpath>

        <!-- Bloques posteriores a la información -->
        <xpath expr="//div[@id='informations']" position="after">
            <t t-if="o.company_id.modo_prueba == True">
                <div style="position:absolute;opacity:0.25;z-index:1000;width:100%;">
                    <center><span style="font-size:60px;color:red;">FACTURA DE PRUEBA</span></center>
                </div>
            </t>

            <t t-if="o.estado_factura == 'factura_cancelada'">
                <div style="position:absolute;opacity:0.25;z-index:1000;width:100%;">
                    <center><span style="font-size:60px;color:red;">CANCELADO</span></center>
                </div>
            </t>

            <div id="comprobante_emision" class="row hdr-block-uni" style="margin-bottom: 5px;">
                <!-- Bandera local -->
                <t t-set="nv_raw" t-value="getattr(o, 'desglosar_iva', getattr(o,'desglose_iva',''))"/>
                <t t-set="nv_is_no" t-value="(nv_raw in ('no','No','NO')) or (nv_raw in (False, 0, None))"/>

                <!-- Mostrar 'Tipo comprobante' SOLO si NO estamos en modo 'no desglosar IVA' -->
                <div class="col-auto mw-100 mb-1"
                     t-if="o.tipo_comprobante and (not nv_is_no)"
                     name="tipo_comprobante" style="line-height: 1.1;">
                    <strong>Tipo comprobante:</strong>
                    <p class="m-0 val" t-field="o.tipo_comprobante"/>
                </div>
                <div class="col-auto mw-100 mb-1" t-if="o.fecha_factura" name="fecha_factura" style="line-height: 1.1;">
                    <strong>Fecha de emisión:</strong>
                    <p class="m-0 val" t-field="o.fecha_factura"/>
                </div>
            </div>
            
            <div name="general_information" class="row hdr-block-uni" style="margin-bottom: 4px;">
                <t t-set="is_nota_venta" t-value="o.move_type == 'out_invoice' and ((getattr(o,'desglosar_iva', getattr(o,'desglose_iva','')) or '') in ('no','No','NO'))"/>
                
                <!-- NOTA DE VENTA: Cliente | Móvil principal -->
                <t t-if="is_nota_venta">
                    <div class="col-12" style="line-height: 1.1;">
                        <div class="row">
                            <div class="col-8">
                                <strong>Cliente:</strong> <span class="val" t-field="o.partner_id.name"/>
                            </div>
                            <div class="col-4">
                                <t t-set="movil_principal" t-value="o.partner_id.mobile or o.partner_id.phone"/>
                                <strong>Móvil principal:</strong>
                                <t t-if="movil_principal"><span class="val" t-esc="movil_principal"/></t>
                                <t t-else=""><span class="val">—</span></t>
                            </div>
                        </div>
                    </div>
                </t>

                <!-- Resto de casos -->
                <t t-else="">
                    <div class="col-6" style="line-height: 1.1;">
                        <span t-if="o.move_type == 'out_invoice'"><strong>Datos receptor:</strong></span>
                        <span t-if="o.move_type == 'in_invoice'"><strong>Datos emisor:</strong></span><br/>
                        <span class="val" t-field="o.partner_id.name"/><br/>
                        <span class="val" t-field="o.partner_id.street"/> <span class="val" t-field="o.partner_id.street2"/><br/>
                        <span class="val" t-field="o.partner_id.state_id.name"/>, <span class="val" t-field="o.partner_id.city"/>
                        - C.P <span class="val" t-field="o.partner_id.zip"/><br/>
                        <strong>RFC Receptor:</strong>
                        <span class="val" t-field="o.partner_id.vat"/><br/>
                        <strong>Régimen fiscal:</strong>
                        <span class="val" t-if="o.partner_id.regimen_fiscal_id">
                            <t t-esc="o.partner_id.regimen_fiscal_id.description or o.partner_id.regimen_fiscal_id.name or o.partner_id.regimen_fiscal_id.display_name"/>
                            <t t-if="o.partner_id.regimen_fiscal_id.code"> (<t t-esc="o.partner_id.regimen_fiscal_id.code"/>)</t>
                        </span>
                        <span class="val" t-if="not o.partner_id.regimen_fiscal_id">—</span>
                        <br/>
                    </div>
                    <div class="col-6" style="line-height: 1.1;">
                        <t t-if="o.move_type == 'out_invoice'">
                            <strong>Datos emisor:</strong><br/>
                            <span class="val">Nombre emisor: </span><span class="val" t-field="o.company_id.nombre_fiscal"/><br/>
                            <span class="val">RFC Emisor: </span><span class="val" t-field="o.company_id.vat"/><br/>
                            <strong>Régimen fiscal:</strong>
                            <span class="val" t-if="o.company_id.regimen_fiscal_id">
                                <t t-esc="o.company_id.regimen_fiscal_id.description or o.company_id.regimen_fiscal_id.name or o.company_id.regimen_fiscal_id.display_name"/>
                                <t t-if="o.company_id.regimen_fiscal_id.code"> (<t t-esc="o.company_id.regimen_fiscal_id.code"/>)</t>
                            </span>
                            <span class="val" t-if="not o.company_id.regimen_fiscal_id">—</span><br/>
                            <strong>Lugar de expedición:</strong>
                            <t t-if="o.journal_id.codigo_postal">
                                <span class="val" t-field="o.journal_id.codigo_postal"/>
                            </t>
                            <t t-else="">
                                <span class="val" t-field="o.company_id.partner_id.zip"/>
                            </t>
                        </t>
                    </div>
                </t>
            </div>
        </xpath>

        <!-- Tabla de líneas (alineación + ocultar "Impuesto" cuando nv_is_no) -->
        <xpath expr="//table[@name='invoice_line_table']" position="replace">
            <table class="table table-sm o_main_table table-borderless invoice-body-11" style="margin-bottom: 5px;">
                <!-- Variables de control -->
                <t t-set="nv_raw" t-value="getattr(o, 'desglosar_iva', getattr(o,'desglose_iva',''))"/>
                <t t-set="nv_is_no" t-value="(nv_raw in ('no','No','NO')) or (nv_raw in (False, 0, None))"/>

                <thead>
                    <tr style="line-height: 1.0;">
                        <th style="padding: 2px 3px;">Clave Producto</th>
                        <th class="text-right" style="padding: 2px 3px;">Cantidad</th>
                        <th class="text-right" style="padding: 2px 3px;">Unidad</th>
                        <th width="40%" style="padding: 2px 3px;">Descripción</th>
                        <th class="text-right" style="padding: 2px 3px;">Precio Unitario</th>
                        <th t-if="display_discount" class="text-right" style="padding: 2px 3px;">Descuento</th>
                        <th t-if="not nv_is_no" class="text-right" style="padding: 2px 3px;">Impuesto</th>
                        <th class="text-right" style="padding: 2px 3px;">
                            <span groups="account.group_show_line_subtotals_tax_excluded">Importe</span>
                            <span groups="account.group_show_line_subtotals_tax_included">Total</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="invoice_tbody">
                    <tr t-foreach="o.invoice_line_ids" t-as="l" style="page-break-inside: avoid; line-height: 1.0;">
                        <!-- Líneas normales (no sección / no nota) -->
                        <t t-if="l.display_type != 'line_section' and l.display_type != 'line_note'">
                            <td style="padding: 1px 2px;">
                                <span t-field="l.product_id.clave_producto"/>
                            </td>
                            <td class="text-right" style="padding: 1px 2px;">
                                <span t-field="l.quantity"/>
                            </td>
                            <td class="text-right" style="padding: 1px 2px;">
                                <span t-field="l.product_id.cat_unidad_medida.clave"/> - <span t-field="l.product_id.cat_unidad_medida.descripcion"/>
                            </td>
                            <td style="padding: 1px 2px; max-width: 200px; word-wrap: break-word;">
                                <span t-field="l.name" t-options="{'widget': 'text'}"/>
                            </td>
                            <td class="text-right" style="padding: 1px 2px;">
                                <span t-field="l.price_unit" t-options='{"widget": "monetary", "display_currency": l.move_id.currency_id}'/>
                            </td>
                            <td t-if="display_discount" class="text-right" style="padding: 1px 2px;">
                                <span t-esc="l.price_unit * ((l.discount or 0.0) / 100.0) * l.quantity"
                                      t-options='{"widget": "monetary", "display_currency": l.move_id.currency_id}'/>
                            </td>
                            <td t-if="not nv_is_no" class="text-right" style="padding: 1px 2px;">
                                <t t-set="taxes_join" t-value="', '.join([(tax.description or tax.name) for tax in l.tax_ids])"/>
                                <span t-esc="taxes_join"/>
                            </td>
                            <td class="text-right" style="padding: 1px 2px;">
                                <span t-field="l.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                                <span t-field="l.price_total" groups="account.group_show_line_subtotals_tax_included"/>
                            </td>
                        </t>

                        <!-- Secciones -->
                        <t t-if="l.display_type == 'line_section'" class="bg-200 font-weight-bold o_line_section">
                            <td colspan="99" style="padding: 1px 2px;">
                                <span t-field="l.name" t-options="{'widget': 'text'}"/>
                            </td>
                        </t>

                        <!-- Notas -->
                        <t t-if="l.display_type == 'line_note'">
                            <td colspan="99" style="padding: 1px 2px;">
                                <span t-field="l.name" t-options="{'widget': 'text'}"/>
                            </td>
                        </t>
                    </tr>
                </tbody>
            </table>
        </xpath>

        <!-- Quitar comunicación de pago duplicada del base -->
        <xpath expr="//p[@name='payment_communication']" position="replace">
        </xpath>

        <!-- Totales y pagos (usando plantillas propias para robustez PDF) -->
        <xpath expr="//div[@class='clearfix mb-4']" position="replace">
            <div class="clearfix mb-4">
                <div id="total" class="row">
                    <!-- Columna izquierda: total en letra + referencia de pago -->
                    <div class="col-6">
                        <div style="color: black; font-size: 12px; padding-top: 10px;">
                            <strong><span t-esc="o._get_amount_2_text(o.amount_total)"/></strong>
                        </div>
                        <p t-if="o.move_type in ('out_invoice', 'in_refund') and o.payment_reference" name="payment_communication" style="margin-top: 15px; font-size: 12px;">
                            <strong>Utilice la siguiente comunicación para su pago:</strong> <b><span t-field="o.payment_reference"/></b>
                            <t t-if="o.partner_bank_id">
                                <br/>
                                <strong>En esta cuenta:</strong> <span t-field="o.partner_bank_id" class="fw-bold"/>
                            </t>
                        </p>
                    </div>
                    
                    <!-- Columna derecha: totales numéricos -->
                    <div t-attf-class="#{'col-6' if report_type != 'html' else 'col-sm-6 col-md-6'}">
                        <table class="table table-sm table-borderless" style="page-break-inside: avoid;">
                            <!-- Pasar flags y tax_totals al render del bloque de totales -->
                            <t t-set="nv_raw" t-value="getattr(o, 'desglosar_iva', getattr(o,'desglose_iva',''))"/>
                            <t t-set="nv_is_no" t-value="(nv_raw in ('no','No','NO')) or (nv_raw in (False, 0, None))"/>
                            <t t-set="tax_totals" t-value="o.tax_totals"/>

                            <!-- Usar nuestras plantillas robustas (PDF-safe) -->
                            <t t-call="cdfi.document_tax_totals_slim"/>

                            <t t-if="print_with_payments">
                                <t t-if="o.payment_state != 'invoicing_legacy'">
                                    <t t-set="payments_vals" t-value="o.sudo().invoice_payments_widget and o.sudo().invoice_payments_widget['content'] or []"/>
                                    <t t-foreach="payments_vals" t-as="payment_vals">
                                        <tr t-if="payment_vals['is_exchange'] == 0">
                                            <td>
                                                <i class="oe_form_field text-end oe_payment_label">Pagado el <t t-esc="payment_vals['date']" t-options='{"widget": "date"}'/></i>
                                            </td>
                                            <td class="text-end">
                                                <span t-esc="payment_vals['amount']" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                            </td>
                                        </tr>
                                    </t>
                                    <t t-if="len(payments_vals) > 0">
                                        <tr class="border-black fw-bold">
                                            <td>Cantidad adeudada</td>
                                            <td class="text-end">
                                                <span t-field="o.amount_residual"/>
                                            </td>
                                        </tr>
                                    </t>
                                </t>
                            </t>
                        </table>
                    </div>
                </div>
            </div>
        </xpath>

        <!-- Bloque CFDI relacionado y datos fiscales -->
        <xpath expr="//div[@name='comment']" position="before">
            <t t-if="o.tipo_relacion">
                <div class="row cfdi-section hdr-block-uni" style="margin-bottom: 5px;">
                    <div><strong>CFDI Relacionado </strong></div>
                    <div><strong>Tipo de Relación:</strong> <span class="val" t-field="o.tipo_relacion"/></div>
                    <div><strong>CFDI Relacionado:</strong> <span class="val" t-field="o.uuid_relacionado"/></span></div>
                </div>
            </t>

            <div t-if="o.folio_fiscal" class="col-12 cfdi-section hdr-block-uni" style="font-size: inherit; margin-top: 15px;">
                <table class="borderless" cellspacing="0" style="width:100%;border:none;border-collapse:separate;border-spacing: 1px; line-height: 1.0;">
                    <tr>
                        <td style="padding: 1px 2px;"><strong>Método de pago</strong></td>
                        <td style="padding: 1px 2px;"><span class="val" t-field="o.methodo_pago"/></td>
                        <td style="padding: 1px 2px;"><strong>Fecha y hora de certificación</strong></td>
                        <td style="padding: 1px 2px;"><span class="val" t-field="o.fecha_certificacion"/></td>
                    </tr>
                    <tr>
                        <td style="padding: 1px 2px;"><strong>Moneda</strong></td>
                        <td style="padding: 1px 2px;"><span class="val" t-field="o.moneda"/></td>
                        <td style="padding: 1px 2px;"><strong>Certificado SAT</strong></td>
                        <td style="padding: 1px 2px;"><span class="val" t-field="o.cetificaso_sat"/></td>
                    </tr>
                    <tr>
                        <td style="padding: 1px 2px;"><strong>Tipo de cambio</strong></td>
                        <td style="padding: 1px 2px;"><span class="val" t-field="o.tipocambio"/></td>
                        <td style="padding: 1px 2px;"><strong>Folio fiscal</strong></td>
                        <td style="padding: 1px 2px;"><span class="val" t-field="o.folio_fiscal"/></td>
                    </tr>
                    <tr>
                        <td style="padding: 1px 2px;"><strong>Número de certificado</strong></td>
                        <td style="padding: 1px 2px;"><span class="val" t-field="o.numero_cetificado"/></td>
                        <td style="padding: 1px 2px;"></td>
                        <td style="padding: 1px 2px;"></td>
                    </tr>
                </table>
            </div>
        </xpath>

        <!-- QR y cadenas -->
        <xpath expr="//div[@name='comment']" position="after">
            <div t-if="o.folio_fiscal" name="cadenas" class="row" style="page-break-inside: avoid; margin-top: 25px; clear: both;">
                <div class="barcode col-3">
                    <img t-if="o.qrcode_image" t-att-src="image_data_uri(o.qrcode_image)" style="height: 120px;width: 120px;"/>
                </div>
                <div class="col-9" style="font-size:7px; line-height: 1.0;">
                    <strong>Cadena Original del Complemento digital del SAT</strong><br/>
                    <span t-field="o.cadena_origenal" style="font-size:6px; line-height: 1.0;"/><br/>

                    <strong>Sello digital del CFDI</strong><br/>
                    <span t-field="o.selo_digital_cdfi" style="font-size:6px; line-height: 1.0;"/><br/>

                    <strong>Sello del SAT</strong><br/>
                    <span t-field="o.selo_sat" style="font-size:6px; line-height: 1.0;"/><br/>
                </div>
            </div>

            <p t-if="o.folio_fiscal" style="margin-top: 15px; clear: both;">
                <center>
                    <strong style="font-size: 10px;">ESTE DOCUMENTO ES UNA REPRESENTACIÓN IMPRESA DE UN CFDI</strong>
                </center>
            </p>
        </xpath>

        <!-- Datos del vehículo (mismo ancho visual que productos) -->
        <xpath expr="//div[@name='comment']" position="before">
            <t t-if="o.invoice_origin">
                <t t-set="sale_order" t-value="o.env['sale.order'].search([('name', '=', o.invoice_origin)], limit=1)"/>
                <t t-if="sale_order">
                    <div class="veh-block">
                        <h4 class="veh-title">Datos del Vehículo</h4>

                        <!-- Variables de apoyo -->
                        <t t-set="marca" t-value="sale_order and (dict(sale_order._fields['marca_auto'].selection).get(sale_order.marca_auto) or '—') or '—'"/>
                        <t t-set="modelo" t-value="(sale_order.nombre_auto.name if sale_order.nombre_auto else '—')"/>
                        <t t-set="anio" t-value="(sale_order.anio_auto or '—')"/>
                        <t t-set="color" t-value="(sale_order.color_auto or '—')"/>
                        <t t-set="vin" t-value="(sale_order.serie_auto or '—')"/>
                        <t t-set="placas" t-value="(sale_order.placas_auto or '—')"/>
                        <t t-set="km" t-value="(sale_order.kilometraje_auto or '—')"/>
                        <t t-set="comb" t-value="(sale_order.tipo_combustible or '—')"/>
                        <t t-set="nivel" t-value="(sale_order.tanque_gasolina or '—')"/>
                        <t t-set="oper" t-value="(sale_order.nombre_operador or '—')"/>
                        <t t-set="unidad" t-value="(sale_order.num_unidad or '—')"/>
                        <t t-set="obs" t-value="(sale_order.observations or '')"/>

                        <table class="table table-sm o_main_table table-bordered veh-table">
                            <colgroup>
                                <col style="width:14%;"/>
                                <col style="width:20%;"/>
                                <col style="width:14%;"/>
                                <col style="width:20%;"/>
                                <col style="width:14%;"/>
                                <col style="width:18%;"/>
                            </colgroup>
                            <tr>
                                <td class="veh-label">Marca</td>
                                <td class="veh-val"><t t-esc="marca"/></td>
                                <td class="veh-label">Modelo</td>
                                <td class="veh-val"><t t-esc="modelo"/></td>
                                <td class="veh-label">Año</td>
                                <td class="veh-val"><t t-esc="anio"/></td>
                            </tr>
                            <tr>
                                <td class="veh-label">Color</td>
                                <td class="veh-val"><t t-esc="color"/></td>
                                <td class="veh-label">VIN</td>
                                <td class="veh-val"><t t-esc="vin"/></td>
                                <td class="veh-label">Placas</td>
                                <td class="veh-val"><t t-esc="placas"/></td>
                            </tr>
                            <tr>
                                <td class="veh-label">Kilometraje</td>
                                <td class="veh-val"><t t-esc="km"/></td>
                                <td class="veh-label">Combustible</td>
                                <td class="veh-val"><t t-esc="comb"/></td>
                                <td class="veh-label">Nivel Comb.</td>
                                <td class="veh-val"><t t-esc="nivel"/></td>
                            </tr>
                            <tr>
                                <td class="veh-label">Operador</td>
                                <td class="veh-val"><t t-esc="oper"/></td>
                                <td class="veh-label">No. Unidad</td>
                                <td class="veh-val"><t t-esc="unidad"/></td>
                                <td class="veh-label">Observaciones</td>
                                <td class="veh-val">
                                    <t t-if="obs"><t t-esc="obs"/></t>
                                    <t t-else="">—</t>
                                </td>
                            </tr>
                        </table>
                    </div>
                </t>
            </t>
        </xpath>

    </template>

    <!-- ============================== -->
    <!--  BLOQUES DE TOTALES (PDF-SAFE) -->
    <!-- ============================== -->

    <!-- Versión slim del document_tax_totals con renombre del subtotal y filtrado IVA 0% cuando nv_is_no -->
    <template id="document_tax_totals_slim">
        <t t-foreach="tax_totals['subtotals']" t-as="subtotal">
            <tr class="border-black o_subtotal">
                <td>
                    <strong t-esc="( (nv_is_no and ((subtotal.get('name') or '').lower() in ('importe sin impuestos','untaxed amount','amount without tax'))) and 'Importe' ) or subtotal.get('name')"/>
                </td>
                <td class="text-end">
                    <span t-att-class="oe_subtotal_footer_separator" t-esc="subtotal.get('formatted_amount')"/>
                </td>
            </tr>

            <!-- Mostrar grupos por subtotal, ocultando IVA 0% si nv_is_no -->
            <t t-set="subtotal_to_show" t-value="subtotal.get('name')"/>
            <t t-call="cdfi.tax_groups_totals_slim"/>
        </t>

        <t t-if="'formatted_rounding_amount' in tax_totals and tax_totals.get('rounding_amount') != 0">
            <td>Rounding</td>
            <td class="text-end">
                <span t-esc="tax_totals.get('formatted_rounding_amount')"/>
            </td>
        </t>

        <!-- Total -->
        <tr class="border-black o_total">
            <td><strong>Total</strong></td>
            <td class="text-end">
                <span t-esc="tax_totals.get('formatted_amount_total_rounded')" t-if="'formatted_amount_total_rounded' in tax_totals"/>
                <span t-esc="tax_totals.get('formatted_amount_total')" t-else=""/>
            </td>
        </tr>
    </template>

    <!-- Lista de grupos por subtotal, con filtro IVA 0% cuando nv_is_no -->
    <template id="tax_groups_totals_slim">
        <t t-foreach="tax_totals.get('groups_by_subtotal', {}).get(subtotal_to_show, [])" t-as="amount_by_group">
            <t t-set="gname" t-value="amount_by_group.get('tax_group_name') or ''"/>
            <t t-if="not (nv_is_no and (gname in ('IVA 0%','IVA 0 %','IVA 0','VAT 0%')))">
                <tr>
                    <t t-if="tax_totals.get('display_tax_base')">
                        <td>
                            <span t-esc="gname"/>
                            <span t-if="not amount_by_group.get('hide_base_amount')" class="text-nowrap"> on
                                <t t-esc="amount_by_group.get('formatted_tax_group_base_amount')"/>
                            </span>
                        </td>
                        <td class="text-end o_price_total">
                            <span class="text-nowrap" t-esc="amount_by_group.get('formatted_tax_group_amount')"/>
                        </td>
                    </t>
                    <t t-else="">
                        <td><span class="text-nowrap" t-esc="gname"/></td>
                        <td class="text-end o_price_total">
                            <span class="text-nowrap" t-esc="amount_by_group.get('formatted_tax_group_amount')"/>
                        </td>
                    </t>
                </tr>
            </t>
        </t>
    </template>

</odoo>
